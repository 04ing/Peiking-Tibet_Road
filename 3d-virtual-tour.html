<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>京藏古道3D虚拟漫游</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10;
            max-width: 300px;
        }
        
        #controls h3 {
            margin-top: 0;
            color: #8B4513;
            font-size: 16px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #333;
        }
        
        .control-group input, .control-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 15px;
            background-color: #8B4513;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #6B340F;
        }
        
        #info-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10;
            max-width: 400px;
        }
        
        #info-panel h3 {
            margin-top: 0;
            color: #8B4513;
            font-size: 16px;
        }
        
        #info-panel p {
            margin: 10px 0;
            font-size: 14px;
            color: #333;
            line-height: 1.5;
        }
        
        #position-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10;
            font-size: 14px;
            color: #333;
        }
        
        .waypoint-marker {
            position: fixed;
            background: rgba(139, 69, 19, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s;
        }
        
        .waypoint-marker:hover {
            background: rgba(107, 52, 15, 0.9);
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <header>
        <div class="container">
            <div class="logo">
                <h1>京藏古道人文环境时空信息开放平台</h1>
                <p>元代北京至西藏的驿路文明</p>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">首页</a></li>
                    <li><a href="index.html#explore" class="active">古道探索</a></li>
                    <li><a href="index.html#map">地图展示</a></li>
                    <li><a href="index.html#dataset">数据集</a></li>
                    <li><a href="index.html#about">关于平台</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- 页面标题 -->
    <section class="page-header">
        <div class="container">
            <h1>京藏古道3D虚拟漫游</h1>
            <p>通过3D技术重现元代北京至西藏的驿路风光，体验古代商旅的艰辛与壮丽</p>
        </div>
    </section>

    <!-- 3D场景容器 -->
    <div id="canvas-container"></div>

    <!-- 位置信息 -->
    <div id="position-info">
        <div>位置: <span id="current-position">北京</span></div>
        <div>海拔: <span id="current-altitude">50</span> 米</div>
        <div>距离: <span id="current-distance">0</span> 公里</div>
    </div>

    <!-- 控制面板 -->
    <div id="controls">
        <h3>漫游控制</h3>
        <div class="control-group">
            <label for="speed">漫游速度</label>
            <input type="range" id="speed" min="0.1" max="5" step="0.1" value="1">
        </div>
        <div class="control-group">
            <label for="view-mode">视角模式</label>
            <select id="view-mode">
                <option value="first-person">第一人称</option>
                <option value="third-person">第三人称</option>
                <option value="top-down">俯视图</option>
            </select>
        </div>
        <div class="control-group">
            <label for="weather">天气效果</label>
            <select id="weather">
                <option value="clear">晴天</option>
                <option value="cloudy">多云</option>
                <option value="rainy">雨天</option>
                <option value="snowy">雪天</option>
            </select>
        </div>
        <button class="btn" id="start-btn">开始漫游</button>
        <button class="btn" id="pause-btn">暂停</button>
        <button class="btn" id="reset-btn">重置</button>
        <h3>快速导航</h3>
        <div id="waypoints"></div>
    </div>

    <!-- 信息面板 -->
    <div id="info-panel">
        <h3 id="location-name">北京</h3>
        <p id="location-description">北京是京藏古道的起点，元代称大都，是当时的政治、经济和文化中心。从这里出发，古道穿越华北平原，进入山西高原，然后沿黄河而上，经过甘肃、青海，最终到达西藏拉萨。</p>
        <p id="historical-info">元代时期，北京作为大都，是蒙古帝国的政治中心。忽必烈建立元朝后，为了加强对西藏的管理，修建了这条连接北京与西藏的驿路，成为两地政治、经济、文化交流的重要通道。</p>
    </div>

    <!-- Three.js 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/FirstPersonControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/geometries/ParametricGeometry.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/geometries/ParametricGeometries.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/objects/Water2.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/objects/Sky.js"></script>

    <script>
        // 场景数据 - AI生成的模拟数据
        const routeData = {
            name: "京藏古道",
            start: "北京",
            end: "拉萨",
            totalLength: 3800,
            waypoints: [
                {
                    id: 1,
                    name: "北京",
                    description: "北京是京藏古道的起点，元代称大都，是当时的政治、经济和文化中心。",
                    historicalInfo: "元代时期，北京作为大都，是蒙古帝国的政治中心。忽必烈建立元朝后，为了加强对西藏的管理，修建了这条连接北京与西藏的驿路。",
                    coordinates: { x: 0, y: 0, z: 0 },
                    altitude: 50,
                    distanceFromStart: 0
                },
                {
                    id: 2,
                    name: "大同",
                    description: "大同是山西省北部的重要城市，位于内外长城之间，是京藏古道上的重要驿站。",
                    historicalInfo: "元代时期，大同是连接中原与草原的重要枢纽，也是京藏古道上的重要补给点。这里保存有许多元代的历史遗迹。",
                    coordinates: { x: 200, y: 50, z: 50 },
                    altitude: 1000,
                    distanceFromStart: 300
                },
                {
                    id: 3,
                    name: "呼和浩特",
                    description: "呼和浩特是内蒙古自治区的首府，位于京藏古道的重要节点上。",
                    historicalInfo: "元代时期，呼和浩特一带是蒙古草原与中原地区的过渡地带，是京藏古道上的重要牧区驿站。",
                    coordinates: { x: 400, y: 100, z: 100 },
                    altitude: 1050,
                    distanceFromStart: 600
                },
                {
                    id: 4,
                    name: "银川",
                    description: "银川是宁夏回族自治区的首府，位于黄河岸边，是京藏古道上的重要城市。",
                    historicalInfo: "元代时期，银川是控制西北边疆的重要军事据点，也是京藏古道上的重要补给站。",
                    coordinates: { x: 600, y: 150, z: 150 },
                    altitude: 1100,
                    distanceFromStart: 900
                },
                {
                    id: 5,
                    name: "兰州",
                    description: "兰州是甘肃省的省会，位于黄河上游，是京藏古道上的重要枢纽。",
                    historicalInfo: "元代时期，兰州是连接中原与西域的重要城市，也是京藏古道上的重要物资集散地。",
                    coordinates: { x: 800, y: 200, z: 200 },
                    altitude: 1500,
                    distanceFromStart: 1200
                },
                {
                    id: 6,
                    name: "西宁",
                    description: "西宁是青海省的省会，位于青藏高原的东部边缘，是京藏古道进入高原的门户。",
                    historicalInfo: "元代时期，西宁是控制青藏高原东部的重要城市，也是京藏古道上的重要宗教中心。",
                    coordinates: { x: 1000, y: 300, z: 250 },
                    altitude: 2200,
                    distanceFromStart: 1500
                },
                {
                    id: 7,
                    name: "格尔木",
                    description: "格尔木位于青海省西部，是京藏古道穿越柴达木盆地的重要驿站。",
                    historicalInfo: "元代时期，格尔木一带是连接青海与西藏的重要通道，虽然自然条件恶劣，但战略地位重要。",
                    coordinates: { x: 1200, y: 400, z: 300 },
                    altitude: 2800,
                    distanceFromStart: 2000
                },
                {
                    id: 8,
                    name: "那曲",
                    description: "那曲位于西藏自治区北部，是京藏古道上的重要牧区城市。",
                    historicalInfo: "元代时期，那曲是西藏北部的重要政治中心，也是京藏古道上的重要驿站。",
                    coordinates: { x: 1400, y: 500, z: 350 },
                    altitude: 4500,
                    distanceFromStart: 3000
                },
                {
                    id: 9,
                    name: "拉萨",
                    description: "拉萨是西藏自治区的首府，是京藏古道的终点，也是藏传佛教的圣地。",
                    historicalInfo: "元代时期，拉萨是西藏的政治、经济和文化中心，也是京藏古道的最终目的地。萨迦派在元朝时期获得了特殊地位。",
                    coordinates: { x: 1600, y: 450, z: 400 },
                    altitude: 3650,
                    distanceFromStart: 3800
                }
            ]
        };

        // 3D场景初始化
        let scene, camera, renderer, controls, animationId;
        let isRoaming = false;
        let currentWaypointIndex = 0;
        let currentPosition = { x: 0, y: 0, z: 0 };
        let speed = 1;
        let viewMode = 'first-person';
        let weather = 'clear';

        function init() {
            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            // 创建相机
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
            camera.position.set(0, 2, 5);

            // 创建渲染器
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // 添加灯光
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);

            // 创建天空
            const sky = new THREE.Sky();
            sky.scale.setScalar(10000);
            scene.add(sky);

            const skyUniforms = sky.material.uniforms;
            skyUniforms.turbidity.value = 10;
            skyUniforms.rayleigh.value = 2;
            skyUniforms.mieCoefficient.value = 0.01;
            skyUniforms.mieDirectionalG.value = 0.8;

            const sunPosition = new THREE.Vector3();
            const theta = Math.PI * (0.49 - 0.5);
            const phi = 2 * Math.PI * (0.25 - 0.5);
            sunPosition.x = Math.cos(phi);
            sunPosition.y = Math.sin(phi) * Math.sin(theta);
            sunPosition.z = Math.sin(phi) * Math.cos(theta);
            skyUniforms.sunPosition.value.copy(sunPosition);

            // 创建地形
            createTerrain();

            // 创建古道
            createRoad();

            // 创建建筑物
            createBuildings();

            // 创建控件
            createControls();

            // 添加路标点
            addWaypoints();

            // 窗口大小调整
            window.addEventListener('resize', onWindowResize, false);

            // 开始动画
            animate();
        }

        // 创建地形
        function createTerrain() {
            const geometry = new THREE.PlaneGeometry(4000, 2000, 100, 100);
            
            // 生成地形高度
            for (let i = 0; i < geometry.vertices.length; i++) {
                const vertex = geometry.vertices[i];
                // 基础高度
                let height = 0;
                
                // 添加山脉
                if (vertex.x > 800) {
                    height = Math.sin(vertex.x * 0.001) * 200 + Math.cos(vertex.z * 0.001) * 100;
                    if (vertex.x > 1200) {
                        height += 200;
                    }
                }
                
                vertex.y = height;
            }
            
            geometry.verticesNeedUpdate = true;
            geometry.computeFaceNormals();
            geometry.computeVertexNormals();
            
            const material = new THREE.MeshPhongMaterial({
                color: 0x88AA66,
                wireframe: false,
                side: THREE.DoubleSide
            });
            
            const terrain = new THREE.Mesh(geometry, material);
            terrain.rotation.x = -Math.PI / 2;
            terrain.position.y = -100;
            scene.add(terrain);
        }

        // 创建古道
        function createRoad() {
            const points = [];
            
            // 从路点创建曲线
            routeData.waypoints.forEach(waypoint => {
                points.push(new THREE.Vector3(
                    waypoint.coordinates.x,
                    waypoint.coordinates.y,
                    waypoint.coordinates.z
                ));
            });
            
            const curve = new THREE.CatmullRomCurve3(points);
            
            const geometry = new THREE.TubeGeometry(curve, 1000, 5, 20, false);
            const material = new THREE.MeshPhongMaterial({ color: 0x8B4513 });
            
            const road = new THREE.Mesh(geometry, material);
            scene.add(road);
        }

        // 创建建筑物
        function createBuildings() {
            // 为每个路点创建建筑物
            routeData.waypoints.forEach(waypoint => {
                const group = new THREE.Group();
                group.position.set(
                    waypoint.coordinates.x,
                    waypoint.coordinates.y,
                    waypoint.coordinates.z
                );
                
                // 创建简单的建筑物
                const buildingGeometry = new THREE.BoxGeometry(20, 15, 20);
                const buildingMaterial = new THREE.MeshPhongMaterial({ color: 0xD2B48C });
                
                for (let i = 0; i < 5; i++) {
                    const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
                    building.position.set(
                        Math.random() * 40 - 20,
                        7.5,
                        Math.random() * 40 - 20
                    );
                    group.add(building);
                }
                
                scene.add(group);
            });
        }

        // 创建控件
        function createControls() {
            // 第一人称控件
            controls = new THREE.FirstPersonControls(camera, renderer.domElement);
            controls.movementSpeed = 10;
            controls.lookSpeed = 0.05;
            controls.lookVertical = true;
            controls.constrainVertical = true;
            controls.maxPolarAngle = Math.PI / 2;
        }

        // 添加路标点
        function addWaypoints() {
            const waypointsContainer = document.getElementById('waypoints');
            
            routeData.waypoints.forEach((waypoint, index) => {
                const button = document.createElement('button');
                button.className = 'btn';
                button.textContent = waypoint.name;
                button.addEventListener('click', () => {
                    currentWaypointIndex = index;
                    updatePosition(waypoint.coordinates);
                    updateInfoPanel(waypoint);
                });
                waypointsContainer.appendChild(button);
            });
        }

        // 更新位置
        function updatePosition(coordinates) {
            currentPosition = coordinates;
            camera.position.set(
                coordinates.x,
                coordinates.y + 2,
                coordinates.z + 5
            );
            
            // 更新位置信息
            document.getElementById('current-position').textContent = routeData.waypoints[currentWaypointIndex].name;
            document.getElementById('current-altitude').textContent = routeData.waypoints[currentWaypointIndex].altitude;
            document.getElementById('current-distance').textContent = routeData.waypoints[currentWaypointIndex].distanceFromStart;
        }

        // 更新信息面板
        function updateInfoPanel(waypoint) {
            document.getElementById('location-name').textContent = waypoint.name;
            document.getElementById('location-description').textContent = waypoint.description;
            document.getElementById('historical-info').textContent = waypoint.historicalInfo;
        }

        // 窗口大小调整
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // 动画
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            if (isRoaming) {
                // 计算下一位置
                if (currentWaypointIndex < routeData.waypoints.length - 1) {
                    const currentWaypoint = routeData.waypoints[currentWaypointIndex];
                    const nextWaypoint = routeData.waypoints[currentWaypointIndex + 1];
                    
                    // 计算方向向量
                    const direction = new THREE.Vector3(
                        nextWaypoint.coordinates.x - currentWaypoint.coordinates.x,
                        nextWaypoint.coordinates.y - currentWaypoint.coordinates.y,
                        nextWaypoint.coordinates.z - currentWaypoint.coordinates.z
                    );
                    
                    const distance = direction.length();
                    direction.normalize();
                    
                    // 更新位置
                    currentPosition.x += direction.x * speed;
                    currentPosition.y += direction.y * speed;
                    currentPosition.z += direction.z * speed;
                    
                    // 更新相机位置
                    camera.position.set(
                        currentPosition.x,
                        currentPosition.y + 2,
                        currentPosition.z + 5
                    );
                    
                    // 朝向前进方向
                    const lookAt = new THREE.Vector3(
                        currentPosition.x + direction.x * 10,
                        currentPosition.y + 2,
                        currentPosition.z + direction.z * 10
                    );
                    camera.lookAt(lookAt);
                    
                    // 检查是否到达下一个路点
                    const currentDistance = new THREE.Vector3(
                        currentPosition.x - currentWaypoint.coordinates.x,
                        currentPosition.y - currentWaypoint.coordinates.y,
                        currentPosition.z - currentWaypoint.coordinates.z
                    ).length();
                    
                    if (currentDistance >= distance) {
                        currentWaypointIndex++;
                        updateInfoPanel(routeData.waypoints[currentWaypointIndex]);
                        
                        // 更新位置信息
                        document.getElementById('current-position').textContent = routeData.waypoints[currentWaypointIndex].name;
                        document.getElementById('current-altitude').textContent = routeData.waypoints[currentWaypointIndex].altitude;
                        document.getElementById('current-distance').textContent = routeData.waypoints[currentWaypointIndex].distanceFromStart;
                    }
                } else {
                    // 到达终点
                    isRoaming = false;
                    document.getElementById('start-btn').textContent = '开始漫游';
                }
            }
            
            if (controls) {
                controls.update();
            }
            
            renderer.render(scene, camera);
        }

        // 事件监听器
        document.getElementById('start-btn').addEventListener('click', function() {
            isRoaming = !isRoaming;
            this.textContent = isRoaming ? '停止漫游' : '开始漫游';
        });

        document.getElementById('pause-btn').addEventListener('click', function() {
            isRoaming = false;
            document.getElementById('start-btn').textContent = '开始漫游';
        });

        document.getElementById('reset-btn').addEventListener('click', function() {
            isRoaming = false;
            currentWaypointIndex = 0;
            updatePosition(routeData.waypoints[0].coordinates);
            updateInfoPanel(routeData.waypoints[0]);
            document.getElementById('start-btn').textContent = '开始漫游';
        });

        document.getElementById('speed').addEventListener('input', function() {
            speed = parseFloat(this.value);
        });

        document.getElementById('view-mode').addEventListener('change', function() {
            viewMode = this.value;
            // 这里可以添加不同视角模式的切换逻辑
        });

        document.getElementById('weather').addEventListener('change', function() {
            weather = this.value;
            // 这里可以添加不同天气效果的切换逻辑
        });

        // 初始化场景
        init();
    </script>

    <!-- 页脚 -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <h3>京藏古道人文环境时空信息开放平台</h3>
                    <p>元代北京至西藏的驿路文明</p>
                </div>
                <div class="footer-links">
                    <h4>快速链接</h4>
                    <ul>
                        <li><a href="index.html">首页</a></li>
                        <li><a href="index.html#explore">古道探索</a></li>
                        <li><a href="index.html#map">地图展示</a></li>
                        <li><a href="index.html#dataset">数据集</a></li>
                        <li><a href="index.html#about">关于平台</a></li>
                    </ul>
                </div>
                <div class="footer-contact">
                    <h4>联系方式</h4>
                    <p>邮箱：contact@jzgd-platform.org</p>
                    <p>电话：010-12345678</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 京藏古道人文环境时空信息开放平台 版权所有</p>
            </div>
        </div>
    </footer>
</body>
</html>