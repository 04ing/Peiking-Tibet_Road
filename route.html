<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>古道路线复原与重建 - 京藏古道人文环境时空信息开放平台</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 高德地图API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=fe4e50125495ae9967861058e720c5dd&plugin=AMap.ToolBar,AMap.Scale"></script>
    <!-- 引入D3.js库 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <!-- 顶部导航栏 -->
    <header>
        <div class="container">
            <div class="logo">
                <h1>京藏古道人文环境时空信息开放平台</h1>
                <p>元代北京至西藏的驿路文明</p>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">首页</a></li>
                    <li><a href="index.html#explore" class="active">古道探索</a></li>
                    <li><a href="index.html#map">地图展示</a></li>
                    <li><a href="index.html#dataset">数据集</a></li>
                    <li><a href="index.html#about">关于平台</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- 页面标题 -->
    <section class="page-header">
        <div class="container">
            <h1>古道路线复原与重建</h1>
            <p>基于历史文献、考古资料和现代地理信息，重现元代京藏古道的路线网络</p>
        </div>
    </section>

    <!-- 路线复原方法 -->
    <section class="route-method">
        <div class="container">
            <h2>路线复原方法</h2>
            <div class="method-content">
                <div class="method-item">
                    <div class="method-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <h3>历史文献分析</h3>
                    <p>系统梳理《元史》、《经世大典》、《永乐大典》等历史文献中关于京藏古道的记载，提取路线走向、驿站设置、行程距离等关键信息。</p>
                </div>
                <div class="method-item">
                    <div class="method-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3>考古资料整合</h3>
                    <p>收集沿线考古发现的驿站遗址、碑刻、文物等资料，结合实地调查，验证和修正文献记载的路线信息。</p>
                </div>
                <div class="method-item">
                    <div class="method-icon">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <h3>地理信息系统</h3>
                    <p>利用现代GIS技术，结合地形、地貌、水系等自然地理要素，对历史路线进行空间定位和可视化展示。</p>
                </div>
            </div>
        </div>
    </section>

    <!-- 主要路线 -->
    <section class="main-routes">
        <div class="container">
            <h2>主要路线</h2>
            <div class="route-map" style="height: 600px; margin-bottom: 30px; position: relative;">
                <div id="amap-container" style="width: 100%; height: 100%;"></div>
                <div id="d3-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
            </div>
            <div class="route-details">
                <div class="route-section">
                    <h3>北京至大同段</h3>
                    <p>起点为元代大都（今北京），经居庸关、宣德府（今宣化）至大同，全长约500公里，是京藏古道的东端起点段。</p>
                    <div class="route-stations">
                        <h4>主要驿站：</h4>
                        <ul>
                            <li>大都（今北京）</li>
                            <li>居庸关</li>
                            <li>宣德府（今宣化）</li>
                            <li>大同</li>
                        </ul>
                    </div>
                </div>
                <div class="route-section">
                    <h3>大同至兰州段</h3>
                    <p>从大同西行，经朔州、代州、太原、汾州、平阳、河中府、同州、华州、京兆府（今西安）、凤翔、秦州至兰州，全长约1500公里。</p>
                    <div class="route-stations">
                        <h4>主要驿站：</h4>
                        <ul>
                            <li>大同</li>
                            <li>太原</li>
                            <li>京兆府（今西安）</li>
                            <li>兰州</li>
                        </ul>
                    </div>
                </div>
                <div class="route-section">
                    <h3>兰州至西宁段</h3>
                    <p>从兰州沿黄河西行，经永登、庄浪至西宁，全长约300公里，是进入青藏高原的过渡段。</p>
                    <div class="route-stations">
                        <h4>主要驿站：</h4>
                        <ul>
                            <li>兰州</li>
                            <li>永登</li>
                            <li>西宁</li>
                        </ul>
                    </div>
                </div>
                <div class="route-section">
                    <h3>西宁至拉萨段</h3>
                    <p>从西宁西南行，经湟源、多巴、日月山、倒淌河、恰卜恰、共和、兴海、玛多、玉树、昌都、工布江达至拉萨，全长约2000公里，是京藏古道的核心段。</p>
                    <div class="route-stations">
                        <h4>主要驿站：</h4>
                        <ul>
                            <li>西宁</li>
                            <li>玉树</li>
                            <li>昌都</li>
                            <li>拉萨</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 支线网络 -->
    <section class="branch-routes">
        <div class="container">
            <h2>支线网络</h2>
            <p>除主线外，京藏古道还有多条重要支线，构成了完整的交通网络：</p>
            <div class="branch-grid">
                <div class="branch-item">
                    <h3>大同至张家口支线</h3>
                    <p>连接大同与张家口，是京藏古道与北方草原丝路的交汇点。</p>
                </div>
                <div class="branch-item">
                    <h3>西宁至河西走廊支线</h3>
                    <p>连接西宁与河西走廊，是京藏古道与丝绸之路的连接通道。</p>
                </div>
                <div class="branch-item">
                    <h3>玉树至康定支线</h3>
                    <p>连接玉树与康定，是京藏古道与川藏古道的重要连接。</p>
                </div>
                <div class="branch-item">
                    <h3>昌都至云南支线</h3>
                    <p>连接昌都与云南，是京藏古道与滇藏古道的交汇点。</p>
                </div>
            </div>
        </div>
    </section>



    <!-- 路线可视化 -->
    <section class="route-visualization">
        <div class="container">
            <h2>路线可视化</h2>
            <p>基于D3.js实现的路线动态可视化，展示小车沿京藏古道从北京到拉萨的行程：</p>
            <div id="d3-route-container" style="width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 30px;"></div>
        </div>
    </section>

    <!-- 底部信息 -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <h3>京藏古道人文环境时空信息开放平台</h3>
                    <p>致力于元代京藏古道的历史研究与数字化保护</p>
                </div>
                <div class="footer-links">
                    <h4>快速链接</h4>
                    <ul>
                        <li><a href="index.html">首页</a></li>
                        <li><a href="index.html#explore">古道探索</a></li>
                        <li><a href="index.html#map">地图展示</a></li>
                        <li><a href="index.html#dataset">数据集</a></li>
                        <li><a href="index.html#about">关于平台</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 京藏古道人文环境时空信息开放平台. 保留所有权利.</p>
            </div>
        </div>
    </footer>

    <script>
        // 路线数据变量
        let routeData = {};

        // 从JSON文件加载数据
        async function loadRouteData() {
            try {
                const response = await fetch('json/route-data.json');
                routeData = await response.json();
                console.log('路线数据加载成功:', routeData);
                return routeData;
            } catch (error) {
                console.error('加载路线数据失败:', error);
                // 使用默认数据作为备用
                return {
                    nodes: [
                        { name: '大都（今北京）', lng: 116.4074, lat: 39.9042, desc: '元代首都，京藏古道起点' },
                        { name: '居庸关', lng: 116.0568, lat: 40.3576, desc: '位于北京西北，是京藏古道出京的第一重要关口' },
                        { name: '大同', lng: 113.2986, lat: 40.1173, desc: '元代称为大同路，是京藏古道的重要枢纽' },
                        { name: '兰州', lng: 103.8343, lat: 36.0611, desc: '元代称为兰州路，是京藏古道进入西北地区的重要节点' },
                        { name: '西宁', lng: 101.7786, lat: 36.6232, desc: '元代称为西宁州，是京藏古道进入青藏高原的门户' },
                        { name: '拉萨', lng: 91.1175, lat: 29.6508, desc: '元代称为萨斯迦，是京藏古道的终点' }
                    ],
                    mainRoute: [
                        [116.4074, 39.9042],
                        [116.0568, 40.3576],
                        [115.032, 40.6234],
                        [114.5566, 40.8184],
                        [113.2986, 40.1173],
                        [112.5493, 37.857],
                        [111.6708, 38.0428],
                        [110.9734, 36.6683],
                        [109.752, 34.3416],
                        [108.9402, 34.3416],
                        [107.5731, 34.3416],
                        [106.1133, 33.8512],
                        [105.7111, 34.5646],
                        [104.3586, 36.0396],
                        [103.8343, 36.0611],
                        [103.2424, 36.7328],
                        [102.4548, 36.8207],
                        [101.7786, 36.6232],
                        [101.6721, 36.313],
                        [100.6195, 36.27],
                        [99.9743, 35.8833],
                        [98.2364, 34.9128],
                        [97.0381, 33.0172],
                        [97.1761, 31.1341],
                        [94.8852, 30.0382],
                        [91.1175, 29.6508]
                    ],
                    branchRoutes: []
                };
            }
        };

        // 初始化高德地图
        function initAMap() {
            const map = new AMap.Map('amap-container', {
                zoom: 5,
                center: [104.0668, 30.5728],
                mapStyle: 'amap://styles/light'
            });

            // 添加工具条
            map.plugin(['AMap.ToolBar', 'AMap.Scale'], function() {
                map.addControl(new AMap.ToolBar());
                map.addControl(new AMap.Scale());
            });

            // 添加主线
            const mainPolyline = new AMap.Polyline({
                path: routeData.mainRoute,
                strokeColor: '#1890ff',
                strokeWeight: 5,
                strokeOpacity: 0.8
            });
            map.add(mainPolyline);

            // 添加主线点击事件
            mainPolyline.on('click', function() {
                const infoWindow = new AMap.InfoWindow({
                    content: `<h3>京藏古道主线</h3><p>从北京出发，经大同、兰州、西宁至拉萨，全长约3500公里，是元代连接中原与西藏的重要交通要道。</p>`,
                    offset: new AMap.Pixel(0, -30)
                });
                infoWindow.open(map, routeData.mainRoute[Math.floor(routeData.mainRoute.length / 2)]);
            });

            // 添加分支路线
            routeData.branchRoutes.forEach(branch => {
                const branchPolyline = new AMap.Polyline({
                    path: branch.path,
                    strokeColor: '#52c41a',
                    strokeWeight: 3,
                    strokeOpacity: 0.6,
                    strokeDasharray: [10, 5]
                });
                map.add(branchPolyline);

                // 添加分支路线点击事件
                branchPolyline.on('click', function() {
                    const infoWindow = new AMap.InfoWindow({
                        content: `<h3>${branch.name}</h3><p>${branch.desc}</p>`,
                        offset: new AMap.Pixel(0, -30)
                    });
                    infoWindow.open(map, branch.path[Math.floor(branch.path.length / 2)]);
                });
            });

            // 添加节点标记
            routeData.nodes.forEach(node => {
                const marker = new AMap.Marker({
                    position: [node.lng, node.lat],
                    title: node.name,
                    icon: new AMap.Icon({
                        size: new AMap.Size(30, 30),
                        image: 'https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png',
                        imageSize: new AMap.Size(30, 30)
                    })
                });
                map.add(marker);

                // 添加信息窗口
                const infoWindow = new AMap.InfoWindow({
                    content: `<h3>${node.name}</h3><p>${node.desc}</p>`,
                    offset: new AMap.Pixel(0, -30)
                });

                marker.on('click', function() {
                    infoWindow.open(map, marker.getPosition());
                });
            });

            // 添加小车动画到高德地图
            addCarAnimationToAMap(map);

            return map;
        }

        // 在高德地图上添加小车动画
        function addCarAnimationToAMap(map) {
            // 创建小车标记
            const carMarker = new AMap.Marker({
                position: routeData.mainRoute[0],
                icon: new AMap.Icon({
                    size: new AMap.Size(40, 40),
                    image: 'https://a.amap.com/jsapi_demos/static/demo-center/icons/car.png',
                    imageSize: new AMap.Size(40, 40)
                }),
                offset: new AMap.Pixel(-20, -20)
            });
            map.add(carMarker);

            // 开始动画
            let i = 1;
            function moveCar() {
                if (i < routeData.mainRoute.length) {
                    const nextPoint = routeData.mainRoute[i];
                    
                    // 更新小车位置
                    carMarker.setPosition(nextPoint);

                    // 计算方向角
                    const prevPoint = routeData.mainRoute[i - 1];
                    const angle = Math.atan2(
                        nextPoint[1] - prevPoint[1],
                        nextPoint[0] - prevPoint[0]
                    ) * 180 / Math.PI;
                    
                    // 更新小车旋转角度
                    carMarker.setAngle(angle);

                    i++;
                    setTimeout(moveCar, 1000);
                } else {
                    // 动画结束后重新开始
                    i = 1;
                    // 将小车重置到起点
                    carMarker.setPosition(routeData.mainRoute[0]);
                    setTimeout(moveCar, 1000);
                }
            }

            moveCar();
        }

        // 初始化D3.js路线可视化
        function initD3RouteVisualization() {
            const container = document.getElementById('d3-route-container');
            const width = container.clientWidth || 800;
            const height = container.clientHeight || 600;
            const padding = { top: 20, right: 20, bottom: 20, left: 20 };

            // 清除现有内容
            container.innerHTML = '';

            // 创建SVG
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // 提取所有经纬度数据用于计算投影范围
            const allCoords = [];
            routeData.mainRoute.forEach(coord => allCoords.push([coord[0], coord[1]]));
            routeData.nodes.forEach(node => allCoords.push([node.lng, node.lat]));

            // 创建地理投影
            const projection = d3.geoMercator()
                .fitExtent([[padding.left, padding.top], [width - padding.right, height - padding.bottom]], {
                    type: 'FeatureCollection',
                    features: [{
                        type: 'Feature',
                        geometry: {
                            type: 'MultiPoint',
                            coordinates: allCoords
                        }
                    }]
                });

            // 创建线条生成器（用于平滑曲线）
            const line = d3.line()
                .x(d => projection([d[0], d[1]])[0])
                .y(d => projection([d[0], d[1]])[1])
                .curve(d3.curveCatmullRom.alpha(0.5));

            // 添加背景
            svg.append('rect')
                .attr('width', width)
                .attr('height', height)
                .style('fill', '#f5f5f5');

            // 添加主线
            const mainPath = svg.append('path')
                .datum(routeData.mainRoute)
                .attr('d', line)
                .style('fill', 'none')
                .style('stroke', '#1890ff')
                .style('stroke-width', 5)
                .style('stroke-opacity', 0.8);

            // 添加分支路线
            routeData.branchRoutes.forEach(branch => {
                svg.append('path')
                    .datum(branch.path)
                    .attr('d', line)
                    .style('fill', 'none')
                    .style('stroke', '#52c41a')
                    .style('stroke-width', 3)
                    .style('stroke-opacity', 0.6)
                    .style('stroke-dasharray', '10,5');
            });

            // 添加节点
            const nodes = svg.selectAll('.node')
                .data(routeData.nodes)
                .enter()
                .append('circle')
                .attr('class', 'node')
                .attr('cx', d => projection([d.lng, d.lat])[0])
                .attr('cy', d => projection([d.lng, d.lat])[1])
                .attr('r', 5)
                .style('fill', '#ff7875')
                .style('stroke', '#fff')
                .style('stroke-width', 2)
                .style('opacity', 1);

            // 添加节点标签
            const labels = svg.selectAll('.node-label')
                .data(routeData.nodes)
                .enter()
                .append('text')
                .attr('class', 'node-label')
                .attr('x', d => projection([d.lng, d.lat])[0] + 10)
                .attr('y', d => projection([d.lng, d.lat])[1] + 4)
                .style('font-size', '10px')
                .style('fill', '#333')
                .style('opacity', 0.7)
                .text(d => d.name);

            // 准备路线点
            const routePoints = routeData.mainRoute.map(coord => {
                const [x, y] = projection([coord[0], coord[1]]);
                return { x, y, original: coord };
            });

            // 创建小车元素
            const car = svg.append('g')
                .attr('class', 'car')
                .attr('transform', `translate(${routePoints[0].x}, ${routePoints[0].y})`);

            // 添加小车车身
            car.append('rect')
                .attr('width', 20)
                .attr('height', 10)
                .attr('x', -10)
                .attr('y', -5)
                .style('fill', '#ff0000')
                .style('stroke', '#000')
                .style('stroke-width', 2);

            // 添加小车车轮
            car.append('circle')
                .attr('cx', -5)
                .attr('cy', 5)
                .attr('r', 3)
                .style('fill', '#000');

            car.append('circle')
                .attr('cx', 5)
                .attr('cy', 5)
                .attr('r', 3)
                .style('fill', '#000');

            // 添加小车车头
            car.append('polygon')
                .attr('points', '10,-5 15,0 10,5')
                .style('fill', '#ff0000')
                .style('stroke', '#000')
                .style('stroke-width', 2);

            // 小车动画函数
            let i = 1;
            function moveCar() {
                if (i < routePoints.length) {
                    const currentPoint = routePoints[i - 1];
                    const nextPoint = routePoints[i];

                    // 计算方向角
                    const dx = nextPoint.x - currentPoint.x;
                    const dy = nextPoint.y - currentPoint.y;
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;

                    // 更新小车位置和旋转角度
                    car.transition()
                        .duration(500)
                        .attr('transform', `translate(${nextPoint.x}, ${nextPoint.y}) rotate(${angle})`);

                    i++;
                    setTimeout(moveCar, 1000);
                } else {
                    // 动画结束后重新开始
                    i = 1;
                    // 将小车重置到起点
                    car.transition()
                        .duration(500)
                        .attr('transform', `translate(${routePoints[0].x}, ${routePoints[0].y}) rotate(0)`);
                    setTimeout(moveCar, 1000);
                }
            }

            // 开始动画
            moveCar();
        }

        // 页面加载完成后初始化
        window.onload = async function() {
            // 先加载路线数据
            await loadRouteData();
            
            // 初始化高德地图
            const map = initAMap();
            
            // 初始化D3.js路线可视化
            initD3RouteVisualization();
        };
    </script>
</body>
</html>